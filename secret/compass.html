<!DOCTYPE html>
<html lang="en">

<!--"Inspired" by https://codepen.io/lachlandcp/pen/BvppxO -->

<head>
    <meta charset="UTF-8">
    <title>Mossranking Political Compass</title>

    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/icon?family=Material+Icons'>

    <style>
        .container {
            padding: 15px 0;
        }


        .btn .material-icons {
            font-size: 20px;
            vertical-align: bottom;
        }

        #diagrams {
            margin: auto;
            width: 600px;
        }

        #axes,
        #scale {
            position: relative;
            border-right: 1px solid grey;
            border-bottom: 1px solid grey;
            box-sizing: content-box;
            display: inline-block;
        }

        #axes {
            width: 600px;
            height: 600px;
            background-size: 100% 100%;
            background-image: url("images/mosscompass.png");
            padding: 10%;
        }

        #axes .auth,
        #axes .lib {
            height: 300px;
        }

        #axes div div {
            height: 300px;
            width: 300px;
            float: left;
        }

        #inner-axes {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .pin {
            position: absolute;
            z-index: 200;
            margin-left: -15.5px;
            margin-top: -15px;
            left: 50%;
            top: 50%;
        }

        .pin i {
            color: white;
            font-size: 200%;
        }

        .partyPin i {
            opacity: 0.5;
        }

        .tooltip-inner {
            max-width: 300px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Mossranking Political Compass</h1>
        <div id="questions">
            <div id="spelunky2" class="card">
                <div class="card-body">
                    <h2 class="card-title">Spelunky 2</h2>
                </div>
                <ul>
                    <li>
                        <p>Should the Four-Leaf Clover be allowed in Low%?</p>
                        <select class="form-control">
                            <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                            <option value='{"loose": 2, "progressive": 0}'>Yes, even when it extends the ghost timer
                            </option>
                            <option value='{"loose": 1, "progressive": 0}'>Yes, unless it extends the ghost timer
                            </option>
                            <option value='{"loose": -1, "progressive": 0}'>No</option>
                        </select>
                    </li>
                    <li>
                        <p>In Low%, should you be allowed to re-collect ropes that were part of your starting inventory?
                        </p>
                        <select class="form-control">
                            <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                            <option value='{"loose": 1, "progressive": 0}'>Yes</option>
                            <option value='{"loose": -1, "progressive": 0}'>Yes, but not in No%</option>
                            <option value='{"loose": -2, "progressive": 0}'>No</option>
                        </select>
                    </li>
                    <li>
                        <p>Should you be allowed to pick up the wooden/metal shield in Low% if you don't push or crush
                            anything?
                        </p>
                        <select class="form-control">
                            <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                            <option value='{"loose": 1, "progressive": 0}'>Yes</option>
                            <option value='{"loose": -1, "progressive": 0}'>No</option>
                        </select>
                    </li>
                    <li>
                        <p>Should you be allowed to throw unloaded Bows and Crossbows, Idols, Curse Pots, Ushabtis, and
                            Eggplants?
                        </p>
                        <select class="form-control">
                            <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                            <option value='{"loose": 1, "progressive": 0}'>Yes</option>
                            <option value='{"loose": -1, "progressive": 0}'>No</option>
                        </select>
                    </li>
                    <li>
                        <p>When should you be allowed to swing Excalibur in Chain Low%?</p>
                        </p>
                        <select class="form-control">
                            <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                            <option value='{"loose": 1, "progressive": 0}'>Always</option>
                            <option value='{"loose": -1, "progressive": 0}'>Only in Abzu</option>
                            <option value='{"loose": -2, "progressive": 0}'>Only to damage Kingu</option>
                        </select>
                    </li>
                    <li>
                        <p>Should you be allowed to cure permanent status effects in Low%?</p>
                        </p>
                        <select class="form-control">
                            <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                            <option value='{"loose": 1, "progressive": 0}'>Yes</option>
                            <option value='{"loose": -1, "progressive": 0}'>No</option>
                        </select>
                    </li>
                    <li>
                        <p>Should you be allowed be cursed in No%?</p>
                        <select class="form-control">
                            <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                            <option value='{"loose": 1, "progressive": 0}'>Yes (if you don't take damage)</option>
                            <option value='{"loose": -1, "progressive": 0}'>No</option>
                        </select>
                    </li>
                    <li>
                        <p>Should you be allowed be poisoned in No%?</p>
                        <select class="form-control">
                            <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                            <option value='{"loose": 1, "progressive": 0}'>Yes (if you don't take damage)</option>
                            <option value='{"loose": -1, "progressive": 0}'>No</option>
                        </select>
                    </li>
                    <li>
                        <p>What should the Low% Cosmic Ocean rules say?</p>
                        <select class="form-control">
                            <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                            <option value='{"loose": 1, "progressive": 0}'>Swinging A Mattock in the Moon Challenge is
                                allowed.</option>
                            <option value='{"loose": -1, "progressive": 0}'>Swinging THE Mattock in the Moon Challenge
                                is allowed.</option>
                        </select>
                    </li>
                </ul>
            </div>
            <br>
            <div id="spelunkyhd" class="card">
                <div class="card-body">
                    <h2 class="card-title">Spelunky HD</h2>
                </div>
            </div>
            <div id="mossranking" class="card">
                <div class="card-body">
                    <h2 class="card-title">Mossranking</h2>
                    <ul>
                        <li>
                            <p>Should Mossranking allow ShopMod categories?</p>
                            <select class="form-control">
                                <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                                <option value='{"loose": 0, "progressive": 1}'>Yes</option>
                                <option value='{"loose": 0, "progressive": -1}'>No</option>
                            </select>
                        </li>
                        <li>
                            <p>Should Low% Jungle/Tide Pool be on Mossranking?</p>
                            <select class="form-control">
                                <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                                <option value='{"loose": 0, "progressive": 1}'>Yes</option>
                                <option value='{"loose": 0, "progressive": -1}'>No</option>
                            </select>
                        </li>
                        <li>
                            <p>How often should Main categories change?</p>
                            <select class="form-control">
                                <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                                <option value='{"loose": 0, "progressive": 2}'>Weekly</option>
                                <option value='{"loose": 0, "progressive": 1}'>Monthly</option>
                                <option value='{"loose": 0, "progressive": -1}'>Yearly</option>
                                <option value='{"loose": 0, "progressive": -2}'>Never</option>
                            </select>
                        </li>
                        <li>
                            <p>In voting, what should it take to change a Main category?</p>
                            <select class="form-control">
                                <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                                <option value='{"loose": 0, "progressive": 1}'>1/2 Majority</option>
                                <option value='{"loose": 0, "progressive": -1}'>2/3 Majority</option>
                            </select>
                        </li>
                        <li>
                            <p>Who should be allowed to vote in rule discussion?</p>
                            <select class="form-control">
                                <option value='{"loose": 0, "progressive": 0}'>No opinion</option>
                                <option value='{"loose": 0, "progressive": 1}'>Everyone</option>
                                <option value='{"loose": 0, "progressive": -1}'>Anyone with a submitted run</option>
                                <option value='{"loose": 0, "progressive": -2}'>Only active runners</option>
                            </select>
                        </li>
                    </ul>
                </div>
            </div>
            <br>
            <button id="results-button" type="button" class="btn btn-success">Results <i
                    class="material-icons">navigate_next</i></button>
        </div>
        <br>
        <div id="results" style="display:none">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Results</h2>
                    <div id="diagrams">
                        <div id="axes">
                            <div id="inner-axes">
                                <div id="userPin" class="pin"><i class="material-icons" data-toggle="tooltip"
                                        title="You">my_location</i></div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <table class="table table-hover">
                        <tbody>
                            <tr>
                                <td>Progressiveness</td>
                                <td id="xScore" data-toggle="tooltip" title="Conservative 0 - 100 Progressive">0</td>
                            </tr>
                            <tr>
                                <td>Strictness</td>
                                <td id="yScore" data-toggle="tooltip" title="Loose 0 - 100 Strict">0</td>
                            </tr>
                        </tbody>
                    </table>

                    <b>You align closest with: <span id="align">nobody</span>.</b>
                </div>
            </div>
            <button id="questions-button" type="button" class="btn btn-success"><i
                    class="material-icons">navigate_before</i> Back to Questions</button>
        </div>

        <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/js/bootstrap.min.js'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.0.1/mustache.min.js'></script>

        <script>
            //Show names when hovering over dots
            $(function () {
                $('[data-toggle="tooltip"]').tooltip({ trigger: 'hover' });
            });

            $("#questions-button").click(function () {
                $("#questions").show();
                $("#results").hide();
            });

            $("#results-button").click(function () {

                //Show results instead of questions
                $("#questions").hide();
                $("#results").show();

                //Tally up results
                var progressive = 0;
                var loose = 0;
                $("select").each(function () {
                    const questionResult = JSON.parse($(this).val());
                    progressive += questionResult.progressive;
                    loose += questionResult.loose;
                });

                //Calculate position on compass
                const { minLoose, maxLoose, minProgressive, maxProgressive } = findExtremes();
                var x = (progressive <= 0) ? (50 + progressive / minProgressive * 50) : (50 - progressive / maxProgressive * 50);
                var y = (loose <= 0) ? (50 - loose / minLoose * 50) : (50 + loose / maxLoose * 50);

                //Place user pin
                $("#userPin").css("left", "" + x + "%");
                $("#userPin").css("top", "" + y + "%");

                //Display scores
                $("#xScore").text(100 - Math.round(x));
                $("#yScore").text(100 - Math.round(y));

                //Show closest other users
                var closestUsers = getClosestUsers(x, y);
                $("#align").text(closestUsers[0]);// + ", then " + closestUsers[1] + ", then " + closestUsers[2]);
            });

            //Find extremes of the quiz
            function findExtremes() {
                let minLoose = 0;
                let maxLoose = 0;
                let minProgressive = 0;
                let maxProgressive = 0;

                // Iterate over each <select> element
                $("select").each(function () {
                    let minLooseQ = Infinity;
                    let maxLooseQ = -Infinity;
                    let minProgressiveQ = Infinity;
                    let maxProgressiveQ = -Infinity;

                    // Iterate over each <option> element
                    $(this).find("option").each(function () {
                        const parsedData = JSON.parse($(this).val());

                        minLooseQ = Math.min(minLooseQ, parsedData.loose);
                        maxLooseQ = Math.max(maxLooseQ, parsedData.loose);
                        minProgressiveQ = Math.min(minProgressiveQ, parsedData.progressive);
                        maxProgressiveQ = Math.max(maxProgressiveQ, parsedData.progressive);
                    });
                    minLoose += minLooseQ;
                    maxLoose += maxLooseQ;
                    minProgressive += minProgressiveQ;
                    maxProgressive += maxProgressiveQ;
                });

                return {
                    minLoose: minLoose,
                    maxLoose: maxLoose,
                    minProgressive: minProgressive,
                    maxProgressive: maxProgressive
                }
            }

            const userResults = {
                "Gugubo": [83, 35],
                "MossRanking": [50, 45],
            };

            //Place dots of other users (???)
            for (var user in userResults) {
                var scores = userResults[user];
                var pin = $("<div/>").
                    addClass("partyPin pin").
                    css("left", "" + (100 - scores[0]) + "%").
                    css("top", "" + (100 - scores[1]) + "%");

                var i = $("<i/>").
                    addClass("material-icons").
                    attr("data-toggle", "tooltip").
                    attr("title", user).
                    text("fiber_manual_record");

                pin.append(i);
                $("#inner-axes").append(pin);
            }

            //Find closest users
            function getClosestUsers(xScore, yScore, excludes = [], n = 3) {
                var closestUser = "";
                var closestUserDistance = Infinity;
                var closestUsers = excludes;

                for (var user in userResults) {
                    if (closestUsers.indexOf(user) > -1) {
                        continue;
                    }
                    var scores = userResults[user];
                    var d = Math.sqrt(Math.abs(Math.pow(xScore - scores[0], 2) + Math.pow(yScore - scores[1], 2)));

                    if (d < closestUserDistance) {
                        closestUserDistance = d;
                        closestUser = user;
                    }
                }

                closestUsers.push(closestUser);
                if (closestUsers.length >= n) {
                    return closestUsers;
                } else {
                    return getClosestUsers(xScore, yScore, closestUsers, n);
                }
            }
        </script>
</body>

</html>